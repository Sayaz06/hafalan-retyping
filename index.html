<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>hafalan retyping</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            slate: {
              900: '#0f172a',
              800: '#1e293b',
              700: '#334155',
            }
          }
        }
      }
    }
  </script>

  <!-- Base path untuk GitHub Pages -->
  <base href="/hafalan-retyping/">

  <!-- Manifest & ikon -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" href="icon-192.png" sizes="192x192" type="image/png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
</head>
<body class="min-h-screen bg-slate-900 text-white">
  <header class="flex items-center justify-between px-4 py-3 border-b border-slate-800">
    <h1 class="text-xl font-semibold tracking-wide">hafalan retyping</h1>
    <div class="flex items-center gap-2">
      <button id="installBtn" class="hidden px-3 py-1 rounded bg-slate-800 hover:bg-slate-700 text-sm">Install</button>
      <button id="logoutBtn" class="hidden px-3 py-1 rounded bg-slate-800 hover:bg-slate-700 text-sm">Log keluar</button>
    </div>
  </header>

  <main id="app" class="p-4">
    <!-- Page login -->
    <section id="page-login" class="grid place-items-center">
      <div class="max-w-md w-full bg-slate-800/50 rounded-lg p-6">
        <h2 class="text-lg font-semibold tracking-wide mb-2">Masuk akaun</h2>
        <p class="text-slate-300 mb-4">Log masuk dengan Google untuk mula menyimpan subjek, topik, dan fakta anda.</p>
        <button id="loginBtn" class="w-full px-4 py-2 rounded bg-slate-800 hover:bg-slate-700 font-semibold tracking-wide">
          Log masuk dengan Google
        </button>
      </div>
    </section>

    <!-- Page subjects -->
    <section id="page-subjects" class="hidden">
      <div class="mb-4 flex items-center gap-2">
        <input id="subjectSearch" type="text" placeholder="Cari subjek..." 
               class="w-full px-3 py-2 rounded bg-slate-800 placeholder-slate-400 
                      focus:outline-none focus:ring-2 focus:ring-slate-700" />
        <button id="addSubjectBtn" 
                class="px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 font-semibold">
          Tambah subjek
        </button>
      </div>
      <div id="subjectsList" class="grid gap-2"></div>
    </section>

    <!-- Page topics -->
    <section id="page-topics" class="hidden">
      <div class="mb-2 flex items-center justify-between">
        <button id="backToSubjects" 
                class="px-3 py-1 rounded bg-slate-800 hover:bg-slate-700 text-sm">
          Kembali
        </button>
        <h3 id="currentSubjectName" class="font-semibold tracking-wide"></h3>
      </div>
      <div class="mb-4 flex items-center gap-2">
        <input id="topicSearch" type="text" placeholder="Cari topik..." 
               class="w-full px-3 py-2 rounded bg-slate-800 placeholder-slate-400 
                      focus:outline-none focus:ring-2 focus:ring-slate-700" />
        <button id="addTopicBtn" 
                class="px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 font-semibold">
          Tambah topik
        </button>
      </div>
      <div id="topicsList" class="grid gap-2"></div>
    </section>

    <!-- Page facts -->
    <section id="page-facts" class="hidden">
      <div class="mb-2 flex items-center justify-between">
        <button id="backToTopics" 
                class="px-3 py-1 rounded bg-slate-800 hover:bg-slate-700 text-sm">
          Kembali
        </button>
        <h3 id="currentTopicName" class="font-semibold tracking-wide"></h3>
      </div>
      <div class="mb-4 flex items-center gap-2">
        <input id="factSearch" type="text" placeholder="Cari fakta..." 
               class="w-full px-3 py-2 rounded bg-slate-800 placeholder-slate-400 
                      focus:outline-none focus:ring-2 focus:ring-slate-700" />
        <button id="addFactBtn" 
                class="px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 font-semibold">
          Tambah fakta hafalan
        </button>
      </div>
      <div id="factsList" class="grid gap-2"></div>
    </section>

    <!-- Page practice -->
    <section id="page-practice" class="hidden">
      <div class="mb-2 flex items-center justify-between">
        <button id="backToFacts" 
                class="px-3 py-1 rounded bg-slate-800 hover:bg-slate-700 text-sm">
          Kembali
        </button>
        <div class="text-sm text-slate-300">
          Jumlah ulangan: <span id="practiceCount">0</span>
        </div>
      </div>
      <div class="mb-3">
        <h4 class="font-semibold tracking-wide mb-1">Fakta</h4>
        <div id="practiceFactTitle" class="text-slate-200"></div>
      </div>
      <div class="mb-3">
        <h4 class="font-semibold tracking-wide mb-1">Ayat</h4>
        <div id="practiceFactSentence" class="text-slate-200"></div>
      </div>
      <div class="mb-3">
        <button id="addPracticeRowBtn" 
                class="px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 font-semibold">
          Tambah ulangan
        </button>
      </div>
      <div id="practiceRows" class="grid gap-4"></div>
      <div class="mt-4">
        <button id="submitPracticeBtn" 
                class="px-4 py-2 rounded bg-slate-800 hover:bg-slate-700 font-semibold">
          Selesai
        </button>
      </div>
      <p id="practiceFeedback" class="mt-2 text-slate-300"></p>
    </section>

  <footer class="px-4 py-6 text-center text-sm text-slate-400">
    Dibina untuk menghafal fakta dengan menulis semula huruf dalam ruang kosong.
  </footer>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, getDocs, query, orderBy, enableIndexedDbPersistence } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDa3a8CIca9rqjOFnYILwfr2miOFARk6Y8",
      authDomain: "hafalan-retyping.firebaseapp.com",
      projectId: "hafalan-retyping",
      storageBucket: "hafalan-retyping.firebasestorage.app",
      messagingSenderId: "922100880106",
      appId: "1:922100880106:web:c658bf5dafad5315b23d93",
      measurementId: "G-EDL6ZF134G"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    // Enable offline persistence
    enableIndexedDbPersistence(db).catch(err => console.warn("Persistence error:", err.code));

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(console.error);
    }

    // State
    let uid = null;
    let currentSubject = null;
    let currentTopic = null;
    let currentFact = null;

    // Elements
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const installBtn = document.getElementById('installBtn');

    // Auth logic
    loginBtn.addEventListener('click', async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error(e);
        alert('Log masuk gagal: ' + e.message);
      }
    });
    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        uid = user.uid;
        logoutBtn.classList.remove('hidden');
        installBtn.classList.remove('hidden');
        showPage('subjects');
        await loadSubjects();
      } else {
        uid = null;
        logoutBtn.classList.add('hidden');
        showPage('login');
      }
    });

    // Simple SPA routing
    const pages = {
      login: document.getElementById('page-login'),
      subjects: document.getElementById('page-subjects'),
      topics: document.getElementById('page-topics'),
      facts: document.getElementById('page-facts'),
      practice: document.getElementById('page-practice'),
    };
    function showPage(name) {
      Object.values(pages).forEach(el => el.classList.add('hidden'));
      pages[name].classList.remove('hidden');
    }

    // === Subjects ===
    const subjectSearch = document.getElementById('subjectSearch');
    const addSubjectBtn = document.getElementById('addSubjectBtn');
    const subjectsList = document.getElementById('subjectsList');

async function loadSubjects(filterText = '') {
      if (!uid) return;
      subjectsList.innerHTML = '';
      const q = query(collection(db, 'users', uid, 'subjects'), orderBy('name', 'asc'));
      const snap = await getDocs(q);
      snap.forEach(d => {
        const data = d.data();
        if (filterText && !data.name.toLowerCase().includes(filterText.toLowerCase())) return;

        const row = document.createElement('div');
        row.className = 'flex items-center justify-between bg-slate-800 rounded px-3 py-2';

        const btn = document.createElement('button');
        btn.className = 'flex-1 text-left hover:text-blue-400';
        btn.textContent = data.name;
        btn.onclick = () => enterSubject({id: d.id, name: data.name});
        row.appendChild(btn);

        const editBtn = document.createElement('button');
        editBtn.textContent = 'âœï¸';
        editBtn.className = 'ml-2 text-sm';
        editBtn.onclick = async () => {
          const newName = prompt('Nama baru subjek:', data.name);
          if (newName) {
            await updateDoc(doc(db, 'users', uid, 'subjects', d.id), { name: newName });
            loadSubjects(subjectSearch.value || '');
          }
        };

        const delBtn = document.createElement('button');
        delBtn.textContent = 'ðŸ—‘ï¸';
        delBtn.className = 'ml-2 text-sm';
        delBtn.onclick = async () => {
          if (confirm('Padam subjek dan semua topik/fakta di dalamnya?')) {
            const topicsSnap = await getDocs(collection(db, 'users', uid, 'subjects', d.id, 'topics'));
            for (const t of topicsSnap.docs) {
              const factsSnap = await getDocs(collection(db, 'users', uid, 'subjects', d.id, 'topics', t.id, 'facts'));
              for (const f of factsSnap.docs) {
                await deleteDoc(f.ref);
              }
              await deleteDoc(t.ref);
            }
            await deleteDoc(doc(db, 'users', uid, 'subjects', d.id));
            loadSubjects(subjectSearch.value || '');
          }
        };

        row.appendChild(editBtn);
        row.appendChild(delBtn);
        subjectsList.appendChild(row);
      });
    }

    subjectSearch.addEventListener('input', e => loadSubjects(e.target.value));
    addSubjectBtn.addEventListener('click', async () => {
      const name = prompt('Nama subjek:');
      if (name) {
        await addDoc(collection(db, 'users', uid, 'subjects'), {name, createdAt: Date.now()});
        loadSubjects(subjectSearch.value || '');
      }
    });

    function enterSubject(s) {
      currentSubject = s;
      document.getElementById('currentSubjectName').textContent = s.name;
      showPage('topics');
      loadTopics();
    }

    // === Topics ===
    const topicSearch = document.getElementById('topicSearch');
    const addTopicBtn = document.getElementById('addTopicBtn');
    const topicsList = document.getElementById('topicsList');
    const backToSubjects = document.getElementById('backToSubjects');

async function loadTopics(filterText = '') {
      if (!uid || !currentSubject) return;
      topicsList.innerHTML = '';
      const q = query(collection(db, 'users', uid, 'subjects', currentSubject.id, 'topics'), orderBy('name', 'asc'));
      const snap = await getDocs(q);
      snap.forEach(d => {
        const data = d.data();
        if (filterText && !data.name.toLowerCase().includes(filterText.toLowerCase())) return;

        const row = document.createElement('div');
        row.className = 'flex items-center justify-between bg-slate-800 rounded px-3 py-2';
        
        const btn = document.createElement('button');
        btn.className = 'flex-1 text-left hover:text-blue-400';
        btn.textContent = data.name;
        btn.onclick = () => enterTopic({id: d.id, name: data.name});
        row.appendChild(btn);

        const editBtn = document.createElement('button');
        editBtn.textContent = 'âœï¸';
        editBtn.className = 'ml-2 text-sm';
        editBtn.onclick = async () => {
          const newName = prompt('Nama baru topik:', data.name);
          if (newName) {
            await updateDoc(doc(db, 'users', uid, 'subjects', currentSubject.id, 'topics', d.id), { name: newName });
            loadTopics(topicSearch.value || '');
          }
        };

        const delBtn = document.createElement('button');
        delBtn.textContent = 'ðŸ—‘ï¸';
        delBtn.className = 'ml-2 text-sm';
        delBtn.onclick = async () => {
          if (confirm('Padam topik dan semua fakta di dalamnya?')) {
            const factsSnap = await getDocs(collection(db, 'users', uid, 'subjects', currentSubject.id, 'topics', d.id, 'facts'));
            for (const f of factsSnap.docs) {
              await deleteDoc(f.ref);
            }
            await deleteDoc(doc(db, 'users', uid, 'subjects', currentSubject.id, 'topics', d.id));
            loadTopics(topicSearch.value || '');
          }
        };

        row.appendChild(editBtn);
        row.appendChild(delBtn);
        topicsList.appendChild(row);
      });
    }

    topicSearch.addEventListener('input', e => loadTopics(e.target.value));
    addTopicBtn.addEventListener('click', async () => {
      const name = prompt('Nama topik:');
      if (name) {
        await addDoc(collection(db, 'users', uid, 'subjects', currentSubject.id, 'topics'), {name, createdAt: Date.now()});
        loadTopics(topicSearch.value || '');
      }
    });

    backToSubjects.addEventListener('click', () => showPage('subjects'));

    function enterTopic(t) {
      currentTopic = t;
      document.getElementById('currentTopicName').textContent = t.name;
      showPage('facts');
      loadFacts();
    }

    // === Facts ===
    const factSearch = document.getElementById('factSearch');
    const addFactBtn = document.getElementById('addFactBtn');
    const factsList = document.getElementById('factsList');
    const backToTopics = document.getElementById('backToTopics');

async function loadFacts(filterText = '') {
      if (!uid || !currentSubject || !currentTopic) return;
      factsList.innerHTML = '';
      const q = query(collection(db, 'users', uid, 'subjects', currentSubject.id, 'topics', currentTopic.id, 'facts'), orderBy('title', 'asc'));
      const snap = await getDocs(q);
      snap.forEach(d => {
        const data = d.data();
        if (filterText && !data.title.toLowerCase().includes(filterText.toLowerCase())) return;

        const row = document.createElement('div');
        row.className = 'flex items-center justify-between bg-slate-800 rounded px-3 py-2';
        
        const btn = document.createElement('button');
        btn.className = 'flex-1 text-left hover:text-blue-400';
        btn.textContent = data.title;
        btn.onclick = () => enterFact({id: d.id, ...data});
        row.appendChild(btn);

        // Butang edit tajuk
        const editTitleBtn = document.createElement('button');
        editTitleBtn.textContent = 'âœï¸ Tajuk';
        editTitleBtn.className = 'ml-2 text-sm';
        editTitleBtn.onclick = async () => {
          const newTitle = prompt('Tajuk baru:', data.title);
          if (newTitle) {
            await updateDoc(doc(db, 'users', uid, 'subjects', currentSubject.id, 'topics', currentTopic.id, 'facts', d.id), {
              title: newTitle
            });
            loadFacts(factSearch.value || '');
          }
        };

        // Butang edit ayat
        const editSentenceBtn = document.createElement('button');
        editSentenceBtn.textContent = 'âœï¸ Ayat';
        editSentenceBtn.className = 'ml-2 text-sm';
        editSentenceBtn.onclick = async () => {
          const newSentence = prompt('Ayat baru:', data.sentence);
          if (newSentence) {
            await updateDoc(doc(db, 'users', uid, 'subjects', currentSubject.id, 'topics', currentTopic.id, 'facts', d.id), {
              sentence: newSentence
            });
            loadFacts(factSearch.value || '');
          }
        };

        // Butang delete
        const delBtn = document.createElement('button');
        delBtn.textContent = 'ðŸ—‘ï¸';
        delBtn.className = 'ml-2 text-sm';
        delBtn.onclick = async () => {
          if (confirm('Padam fakta ini?')) {
            await deleteDoc(doc(db, 'users', uid, 'subjects', currentSubject.id, 'topics', currentTopic.id, 'facts', d.id));
            loadFacts(factSearch.value || '');
          }
        };

        row.appendChild(editTitleBtn);
        row.appendChild(editSentenceBtn);
        row.appendChild(delBtn);
        factsList.appendChild(row);
      });
    }

    factSearch.addEventListener('input', e => loadFacts(e.target.value));
    addFactBtn.addEventListener('click', async () => {
      const title = prompt('Tajuk fakta:');
      const sentence = prompt('Ayat fakta:');
      if (title && sentence) {
        await addDoc(collection(db, 'users', uid, 'subjects', currentSubject.id, 'topics', currentTopic.id, 'facts'), {
          title, sentence, attempts: 0, createdAt: Date.now()
        });
        loadFacts(factSearch.value || '');
      }
    });

    backToTopics.addEventListener('click', () => showPage('topics'));

    async function enterFact(f) {
      currentFact = f;
      document.getElementById('practiceFactTitle').textContent = f.title;
      document.getElementById('practiceFactSentence').textContent = f.sentence;
      document.getElementById('practiceCount').textContent = f.attempts || 0;
      showPage('practice');
      await loadPracticeRows();
    }

    // === Practice ===
    const addPracticeRowBtn = document.getElementById('addPracticeRowBtn');
    const submitPracticeBtn = document.getElementById('submitPracticeBtn');
    const practiceRows = document.getElementById('practiceRows');
    const practiceFeedback = document.getElementById('practiceFeedback');
    const backToFacts = document.getElementById('backToFacts');

    function createRow(sentence) {
      const row = document.createElement('div');
      row.className = 'flex flex-wrap gap-2';
      const inputs = [];

      Array.from(sentence).forEach(ch => {
        if (ch === ' ') {
          const spacer = document.createElement('div');
          spacer.className = 'w-3';
          row.appendChild(spacer);
        } else {
          const input = document.createElement('input');
          input.type = 'text';
          input.maxLength = 1;
          input.className = 'w-8 h-8 text-center rounded bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-700';
          input.dataset.char = ch;

          input.style.textTransform = 'lowercase';
          input.autocapitalize = 'none';
          input.spellcheck = false;
input.addEventListener('input', () => {
            input.value = input.value.toLowerCase();
          });
          
          // Tambah ini untuk elakkan delay pemprosesan sistem keyboard
          input.setAttribute('autocomplete', 'off');
          input.setAttribute('inputmode', 'text'); // Memastikan keyboard muncul laju

          inputs.push(input);
          row.appendChild(input);
        }
      });

// Auto-tab behaviour (Fast Response)
      inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          if (input.value.length >= 1) {
            if (index < inputs.length - 1) {
              // Guna requestAnimationFrame untuk kelajuan input maksimum
              requestAnimationFrame(() => inputs[index + 1].focus());
            }
          }
        });
        input.addEventListener('keydown', (e) => {
          if (e.key === "Backspace" && input.value === "") {
            if (index > 0) {
              inputs[index - 1].focus();
            }
          }
        });
      });

      return row;
    }

    addPracticeRowBtn.addEventListener('click', async () => {
      if (currentFact) {
        const ref = doc(db, 'users', uid, 'subjects', currentSubject.id, 'topics', currentTopic.id, 'facts', currentFact.id);
        const rowsCol = collection(ref, 'rows');
        await addDoc(rowsCol, {
          sentence: currentFact.sentence,
          createdAt: Date.now(),
          answers: []
        });
        loadPracticeRows();
      }
    });

    submitPracticeBtn.addEventListener('click', async () => {
      let total = 0, correct = 0;
      const answers = [];

      practiceRows.querySelectorAll('input').forEach(inp => {
        total++;
        const isCorrect = inp.value === inp.dataset.char;
        answers.push({char: inp.dataset.char, input: inp.value, correct: isCorrect});
        if (isCorrect) {
          inp.classList.add('bg-green-800');
          correct++;
        } else {
          inp.classList.add('bg-red-800');
        }
      });

      practiceFeedback.textContent = `Betul ${correct}/${total}`;

      if (currentFact) {
        const ref = doc(db, 'users', uid, 'subjects', currentSubject.id, 'topics', currentTopic.id, 'facts', currentFact.id);
        await updateDoc(ref, {attempts: (currentFact.attempts || 0) + 1});
        currentFact.attempts++;
        document.getElementById('practiceCount').textContent = currentFact.attempts;

        // Update row terakhir dengan jawapan
        const rowsCol = collection(ref, 'rows');
        const q = query(rowsCol, orderBy('createdAt', 'desc'));
        const snap = await getDocs(q);
        if (!snap.empty) {
          const lastRow = snap.docs[0];
          await updateDoc(lastRow.ref, {answers, correct, total});
        }
      }
    });

    async function loadPracticeRows() {
      practiceRows.innerHTML = '';
      const ref = doc(db, 'users', uid, 'subjects', currentSubject.id, 'topics', currentTopic.id, 'facts', currentFact.id);
      const q = query(collection(ref, 'rows'), orderBy('createdAt', 'asc'));
      const snap = await getDocs(q);

      snap.forEach(d => {
        const data = d.data();
        const rowWrapper = document.createElement('div');
        rowWrapper.className = 'space-y-1';

        const row = createRow(data.sentence);
        if (data.answers && data.answers.length > 0) {
          row.querySelectorAll('input').forEach((inp, i) => {
            inp.value = data.answers[i].input;
            if (data.answers[i].correct) inp.classList.add('bg-green-800');
            else inp.classList.add('bg-red-800');
          });
        }
        rowWrapper.appendChild(row);

        const meta = document.createElement('div');
        meta.className = 'flex justify-between text-xs text-slate-400';
        meta.textContent = `Siap pada ${new Date(data.createdAt).toLocaleString()}`;

        const delBtn = document.createElement('button');
        delBtn.textContent = 'ðŸ—‘ï¸ Buang history';
        delBtn.className = 'ml-2';
        delBtn.onclick = async () => {
          await deleteDoc(d.ref);
          loadPracticeRows();
        };
        meta.appendChild(delBtn);

        rowWrapper.appendChild(meta);
        practiceRows.appendChild(rowWrapper);
      });
    }

    backToFacts.addEventListener('click', () => showPage('facts'));

  </script>
</body>
</html>

